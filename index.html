<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

<style>
input {
  margin:10px;
  width:60px;
}
</style>
<main role="main">

  <section class="jumbotron text-center">
    <div class="container">
      <h1 class="jumbotron-heading">
        Tiebreaker Calc
      </h1>
    </div>
  </section>
  <div class="album py-5 bg-light">
    <div class="container">
      <div class="row">
        <p><b>Team 1 Sum: <span id="team1_tot"></span></b></p>
        <div id="team1"></div>
      </div>
    </div>
  </div>

  <div class="album py-5 bg-light">
    <div class="container">
      <div class="row">
        <p><b>Team 2 Sum: <span id="team2_tot"></span></b></p>
        <div id="team2"></div>
      </div>
    </div>
  </div>
</main>
<script>
let initialRendered = false
let allPokemon = []
$.ajax('https://pokeapi.co/api/v2/pokemon?offset=0&limit=10000').done((body) => {
  console.log(body)
  allPokemon = body.results
  allPokemon.unshift({'name': 'no pokemon', 'url': ''})
  renderAllDD()
})

$(document).on('change', '.pokemon-dd', function(e) {
  let team = $(this).data('team')
  let num = $(this).data('num')
  $.ajax($(this).val()).done((body) => {
    $(`#${team}_${num}_img`).html(`<img style="height: 50px;vertical-align: middle;" src="${body.sprites.front_default}" />`)
    $(`#p${num}t${team}_base`).val(body.stats[0].base_stat)
    let max = calcMaxHP(
      parseInt($(`#p${num}t${team}_base`).val()) || 0,
      parseInt($(`#p${num}t${team}_ev`).val()) || 0,
      parseInt($(`#p${num}t${team}_iv`).val()) || 0,
      parseInt($(`#p${num}t${team}_level`).val()) || 50,
    )
    $(`#p${num}t${team}_curr`).val(max)
    $(`#p${num}t${team}_max_force`).val(max)
    doCalc()
  })
})

function renderAllDD() {
  for(let teamId = 1;teamId <= 2; teamId++) {
    for(let i = 0; i< 4;i++) {
      for(let j = 0, listLen = allPokemon.length; j < listLen; j++) {
        $(`#pokemon_dd_${teamId}_${i}`).append(`
          <option value="${allPokemon[j].url}">${allPokemon[j].name}</option>
        `)
      }
    }
  }
}

function calcMaxHP(base, evs, ivs, level) {
  let total;
  if (base === 1) {
    total = 1;
  } else {
    total =
      Math.floor(((base * 2 + ivs + Math.floor(evs / 4)) * level) / 100) +
      level +
      10;
  }
  return total;
}

function doCalc(e) {
	for(let teamId = 1;teamId <= 2; teamId++) {
  	let teamSum = 0
    let teamSumMax = 0
  	for(let i = 0; i< 4;i++) {
    	let max = calcMaxHP(
      	parseInt($(`#p${i}t${teamId}_base`).val()) || 0,
      	parseInt($(`#p${i}t${teamId}_ev`).val()) || 0,
      	parseInt($(`#p${i}t${teamId}_iv`).val()) || 0,
      	parseInt($(`#p${i}t${teamId}_level`).val()) || 50,
      )
      let currDefault = 0
      if(!initialRendered) currDefault = max
      let cur = Math.min(max,($(`#p${i}t${teamId}_curr`).val() != '') ? parseInt($(`#p${i}t${teamId}_curr`).val()) : currDefault)
      let per = (100*cur/max)
      teamSum += cur
      teamSumMax += max
      if(e == undefined || $(e.target).data('field') != 'curr-hp') {
        $(`#p${i}t${teamId}_curr`).val(cur)
      }
      if(e == undefined || $(e.target).data('field') != 'max') {
        $(`#p${i}t${teamId}_max_force`).val(max)
      }
    	//$(`#p${i}t${teamId}_per`).text(per.toString() + '%')
    }
    $(`#team${teamId}_tot`).text((100*teamSum/teamSumMax).toString() + '%')
  }
}

for(let teamId = 1;teamId <= 2; teamId++) {

  for(let i = 0; i< 4;i++) {
  $(`#team${teamId}`).append(`
            <div class="col-md-2" style="display:inline-block;min-width:250px;text-align:center;">
              <div class="card md-2 box-shadow">
                <span id="${teamId}_${i}_img"></span>
    Pokemon ${i}:
    <select id="pokemon_dd_${teamId}_${i}" class="pokemon-dd" data-team="${teamId}" data-num="${i}"></select>
    <div style="text-align:left">
      <div>Base HP: <input id="p${i}t${teamId}_base" placeholder="Base" data-field="base" type="number" /></div>
      <div>IV: <input id="p${i}t${teamId}_iv" placeholder="0" data-field="iv" type="number" /></div>
      <div>EV: <input id="p${i}t${teamId}_ev" placeholder="0" data-field="ev" type="number" /></div>
      <div>Level: <input id="p${i}t${teamId}_level" placeholder="50" data-field="level" type="number"/></div>
    </div>
    <div><div>HP: <input id="p${i}t${teamId}_curr" data-field="curr-hp" placeholder="Curr HP" type="number" min=0 /> / <input id="p${i}t${teamId}_max_force" data-field="max" placeholder="Max HP" type="number" /></div>
    </div></div>
  `)
  }
}

$(document).on('keyup change', (e) => {
  console.log(e)
	doCalc(e)
})

doCalc()

initialRendered = true

</script>
